<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link  rel="stylesheet" href="./music.css">
    <title>网页播放器</title>
</head>
<body>
    <div id="main_player">
        <div id="player_title" >
            <div>
                <div id="add_songname"><span>添加歌曲名字:</span><input type="text" class="addtext" placeholder="+后缀(默认.mp3)"></div>
                <div id="add_songimg"><span>添加歌曲图片:</span><input type="text" class="addtext" placeholder="+后缀(默认.jpg)"></div>
                <div id="add_songlyc"><span>添加歌词:</span><input type="text" class="addtext"placeholder="[时间]歌词"></div>
                <button id="add_songinfo" onclick="add_songinfo()">增加歌曲</button>     
                <button id="add_songback" onclick="add_songback()">返回</button>             
            </div>
            <span title="添加歌曲" onclick="Titlehidden()">我的歌单</span></div>
        <div id="List">
            <div id="song_list"></div>
        </div>
        <div id="singer_img"></div>
        <div id="controls_list">
            <div id="songname_audio"></div>
            <div id="song_progress"><span></span></div>
            <div id="mode_button"></div>
            <div id="last_button" title="上一首"><div></div></div>
            <div id="play_button_div"title="播放" ><div class="play_button" ></div></div>
            <div id="next_button" title="下一首"><div></div></div>
            <div id="voice_button_div" title="音量"><div id="voice_button"></div>
                <div id="voice_range_border">
                    <span id="voice_value">0</span>
                    <input type="range" min="0" max="1" id="voice_range" value="0.4" step="0.01" onclick="voice_adjust()">
                </div>
            </div>
            <div id="progress_bar">
                <input type="range" min="0" max="400" id="song_range" value="0" step="1" onclick="time_adjust()">
            </div>
        </div>
    </div>
    <div id="lyrics_main_div"></div> 
    <div id="lyrics_text">
        <textarea id="毛不易 - 别再闹了" hidden>[00:00.00]《别再闹了》
            [00:03.00]演唱：毛不易
            [00:06.00]作词/作曲：小柯
            [00:09.00]歌词编辑：孟德良
            [00:12.00]2019年01月07日
            [00:15.00]
            [00:16.80]我们聊些 有趣的事情
            [00:20.85]别把气氛弄的 如此低沉
            [00:25.31]我知道 这几天你心烦
            [00:29.76]每个人的活 都不简单
            [00:32.49]
            [00:33.19]我知道 如果把你换做我
            [00:37.93]我也会冲动 也会不安
            [00:41.83]即使天塌了 还有我在身边
            [00:46.59]没有什么 不解的难
            [00:50.54]
            [00:51.24]外面纷纷扰扰 里面乱乱糟糟
            [00:55.05]我们别再闹了
            [00:58.55]这个冬天 已然很冷了
            [01:02.74]我们靠在一起 好吗
            [01:07.03](Music)
            [01:21.92]我们聊些 有趣的事情
            [01:26.05]别把气氛弄的 如此低沉
            [01:30.51]我知道 这几天你心烦
            [01:34.96]每个人的活 都不简单
            [01:39.03]
            [01:39.73]外面纷纷扰扰 里面乱乱糟糟
            [01:43.38]我们别再闹了
            [01:47.08]现实生活 本来已很累了
            [01:51.54]把你的手给我吧
            [01:55.90]
            [01:56.60]外面纷纷扰扰 里面乱乱糟糟
            [02:00.18]我们别再闹了
            [02:03.83]这个冬天 已然很冷了
            [02:08.17]我们靠在一起 好吗
            [02:13.35](Music)
            [02:28.32]外面纷纷扰扰 里面乱乱糟糟
            [02:31.70]我们别再闹了
            [02:35.41]这个冬天 已然很冷了
            [02:39.70]我们靠在一起 好吗
            [02:44.24]
            [02:44.94]外面纷纷扰扰 里面乱乱糟糟
            [02:48.56]我们别再闹了
            [02:52.27]现实生活 本来已很累了
            [02:56.79]把你的手给我吧
            [03:00.04]
            [03:00.74]这个冬天 已然很冷了
            [03:05.05]我们靠在一起 好吗</textarea>
        <textarea id="薛之谦 - 丑八怪" hidden>[00:00.63]丑八怪 - 薛之谦
            [00:03.13]作词：甘世佳
            [00:05.32]作曲：李荣浩 
            [00:16.98]
            [00:20.26]如果世界漆黑 其实我很美
            [00:23.88]在爱情里面进退 最多被消费
            [00:27.70]不管同样的是非
            [00:29.69]又怎么不对 无所谓
            [00:35.69]如果像你一样 总有人谄媚
            [00:39.32]围绕着我的卑微 也许能消退
            [00:43.32]其实我并不在意 有很多机会
            [00:46.69]像巨人一样的无畏
            [00:49.51]放纵我心里的鬼
            [00:51.20]可是我不配
            [00:54.46]丑八怪 能否别把灯打开
            [01:02.21]我要的爱 出没在漆黑一片的舞台
            [01:09.46]丑八怪 在这暧昧的时代
            [01:17.58]我的存在 像意外
            [01:24.48]
            [01:37.79]有人用一滴泪 会红颜祸水
            [01:41.35]有人丢掉称谓 什么也不会
            [01:45.29]只要你足够虚伪
            [01:47.10]就不怕魔鬼 对不对
            [01:53.05]如果剧本写好 谁比谁高贵
            [01:56.74]我只能沉默以对 美丽本无罪
            [02:00.63]当欲望开始贪杯 有更多机会
            [02:04.07]像尘埃一样的无畏
            [02:06.89]化成灰谁认得谁管他配不配
            [02:08.65]
            [02:11.96]丑八怪 能否别把灯打开
            [02:19.52]我要的爱 出没在漆黑一片的舞台
            [02:26.83]丑八怪 在这暧昧的时代
            [02:34.96]我的存在 不意外
            [02:42.33]
            [03:01.96]丑八怪 其实见多就不怪
            [03:09.96]放肆去high 用力踩
            [03:14.15]那不堪一击的洁白
            [03:17.21]丑八怪 这是我们的时代
            [03:25.48]我不存在 才意外</textarea>
    </div>
</body>
<script>
    //如要增加歌曲，只需往根目录添加 MP3 文件后，在song_info处增加歌曲的名字，歌手图片的名字，歌词 textarea 的id需要与歌曲名字相同
    const song_info={
        song_name:["毛不易 - 别再闹了.mp3","薛之谦 - 丑八怪.mp3","赵雷 - 鼓楼.mp3","骆集益 - 玉满堂.mp3"],
        songimg_name:["毛不易 - 别再闹了.jpg","薛之谦 - 丑八怪.jpg","赵雷 - 鼓楼.jpg"],
        songlrc_id:["毛不易 - 别再闹了","薛之谦 - 丑八怪","赵雷 - 鼓楼","骆集益 - 玉满堂"]
    };
    //歌曲目录
    let songnum=0,progresstime,lyrics_progress;
    window.onload= function(){
        songnamelist(song_info.song_name);
        songload();
        add_song_img();
        voice_adjust();
        Lyrics_load();
        document.querySelector("#songname_audio>div.display>audio").addEventListener("canplaythrough",progress);
    }
    function songnamelist(arr){                                                                            //增加歌曲列表
        for(let i=0;i<arr.length;i++){
            let songname_div=document.createElement("div");
            let songname_span=document.createElement("span")
            let songname_text=document.createTextNode(arr[i].slice(0,arr[i].indexOf(".")))
            songname_span.appendChild(songname_text);
            songname_div.appendChild(songname_span);
            songname_div.onclick=function(){song_select(this)};
            document.getElementById("song_list").appendChild(songname_div);
        }
    }
    function songload(){                                                                         //载入歌曲文件
        let songname_div=document.createElement("div");
        let song_audio=document.createElement("audio");
        try{
            song_audio.src="./img/"+song_info.song_name[songnum]+"";
        }catch(e){console.log(e)}
        songname_div.appendChild(song_audio);
        songname_div.className="display";
        document.getElementById("songname_audio").appendChild(songname_div);
        document.getElementById("song_list").childNodes[songnum].className="song_playing"
    }
    function add_song_img(){                                                                       //载入歌手图片
            let songname_div=document.createElement("div")
            let song_img=document.createElement("img");
            try{song_img.src="./img/"+song_info.songimg_name[songnum]+"";
                if(song_img.src.indexOf("undefined")>0||song_info.songimg_name[songnum].length<4) {throw new Error("Error")}
                document.getElementById("singer_img").innerHTML="";
            }catch(e){
                song_img.src="./img/unknow-img.jpg";
                document.getElementById("singer_img").innerHTML="没有找到图片"
            }
            song_img.className="song_img";
            song_img.alt="没有找到图片"
            songname_div.appendChild(song_img);
            songname_div.className="song_img_div"
            document.getElementById("singer_img").appendChild(songname_div);
    }
    function Titlehidden(){
        document.querySelector("#player_title>div").style="display:block";
        document.querySelector("#player_title>span").style="display:none";
    }
    function add_songback(){
        document.querySelector("#player_title>div").style="display:none";
        document.querySelector("#player_title>span").style="display:block";
    }
    function add_songinfo(){                                                                        //增加歌曲
        let info= document.getElementsByClassName("addtext");
        const obj_info={
            song_name:"",
            songimg_name:"",
        };
        obj_info.song_name=(info[0].value);
        obj_info.songimg_name=(info[1].value);
        try{if(obj_info.song_name==""){throw ("请输入歌曲名字")}}catch(e){alert(e);return;}
        if(obj_info.song_name.indexOf(".")<0){
            obj_info.song_name=obj_info.song_name+".mp3"
        }            
        if(obj_info.songimg_name.indexOf(".")<0&obj_info.songimg_name.length>0){obj_info.songimg_name=obj_info.songimg_name+".jpg"};
        song_info.song_name.push((obj_info.song_name));
        song_info.songimg_name[song_info.song_name.length-1]=(obj_info.songimg_name)
        song_info.songlrc_id[song_info.song_name.length-1]=(obj_info.song_name).slice(0,obj_info.song_name.indexOf("."));
        let arr=[obj_info.song_name];
        songnamelist(arr);
        //处理歌词
        if(info[2].value==""){return;}
        let songlrc=document.createElement("textarea");
        songlrc.innerHTML=info[2].value;
        songlrc.hidden=true;
        songlrc.id=song_info.songlrc_id[song_info.song_name.length-1];
        document.getElementById("lyrics_text").appendChild(songlrc);
    }
    function last_song(){                                                                               //上一首歌
        let songname=document.querySelector("#songname_audio>div.display");
        let song_img=document.querySelector("#singer_img>div.song_img_div");
        let song_playing=document.querySelector("#song_list>div.song_playing");
        document.getElementById("songname_audio").removeChild(songname);
        document.getElementById("singer_img").removeChild(song_img);
        if(songnum>0){
            songnum=songnum-1;
            songload();
            add_song_img();
            song_playing.previousSibling.className="song_playing"
        }else if(songnum==0){
            songnum=song_info.song_name.length-1;
            songload();
            add_song_img();
            document.querySelector("#song_list>div:last-child").className="song_playing"
        }
        song_playing.className="";
        clearAll();
    }
    function next_song(){                                                                              //下一首歌
        let songname=document.querySelector("#songname_audio>div.display");
        let song_img=document.querySelector("#singer_img>div.song_img_div");
        let song_playing=document.querySelector("#song_list>div.song_playing");
        document.getElementById("songname_audio").removeChild(songname);
        document.getElementById("singer_img").removeChild(song_img);
        if(songnum<song_info.song_name.length-1){
            songnum=songnum+1;
            songload();
            add_song_img();
            song_playing.nextSibling.className="song_playing"
        }else if(songnum==song_info.song_name.length-1){
            songnum=0;
            songload();
            add_song_img();
            document.querySelector("#song_list>div:first-child").className="song_playing"
        }
        song_playing.className="";
        clearAll();
    }
    function song_select(obj){                                                                      //列表选择歌曲
        let songname=document.querySelector("#songname_audio>div.display");
        let song_img=document.querySelector("#singer_img>div.song_img_div");
        document.getElementById("songname_audio").removeChild(songname);
        document.getElementById("singer_img").removeChild(song_img);
        document.getElementById("song_list").childNodes[songnum].className=""
        for(let i=0;i<song_info.song_name.length;i++){
            if(obj==song_list.childNodes[i]){
                songnum=i;
                songload();
                add_song_img();
                obj.className="song_playing";
            }
        }
        clearAll();
    }
    function clearAll(){                                                                                //切换歌曲时重置信息
        let button=document.getElementById("play_button_div").childNodes[0];
        let audio=document.querySelector("#songname_audio>div.display").childNodes[0];
        if(button.className=="play_button"){
            audio.pause();
        }else if(button.className=="stop_button"){
            audio.play();
        }
        voice_adjust();
        setTimeout(progress,100);
        let song_lyrics=document.getElementById("lyrics_main_div").childNodes;
        document.getElementById("lyrics_main_div").removeChild(song_lyrics[0]);
        Lyrics_load();
    }
    function playbutton(){                                                                           //播放与暂停按钮
          let button=document.getElementById("play_button_div").childNodes[0];
          let audio=document.querySelector("#songname_audio>div.display").childNodes[0];
          if(button.className=="play_button"){
              audio.play();
              button.className="stop_button";
              document.getElementById("play_button_div").title="暂停"
              progresstime=setInterval(progress,1000);
              lyrics_progress=setInterval(Lyrics_roll,1000);
          }else if(button.className=="stop_button"){
                button.className="play_button";
                document.getElementById("play_button_div").title="播放"
                setTimeout(audio.pause(),100);
                clearInterval(progresstime);
                clearInterval(lyrics_progress);
          }
    }
    function visibility_voice_bar(){                                                              //音量条的显示与否
          let voice_bar=document.getElementById("voice_range_border")
          if(voice_bar.style.display=="flex"){
              voice_bar.style.display="none"
          }else{
              voice_bar.style.display="flex"
          } 
    }
    function voice_adjust(){                                                                      //音量调节
        let audio=document.querySelector("#songname_audio>div.display").childNodes[0];
        let value=document.getElementById("voice_value")
        let volume_range=document.getElementById("voice_range");
        audio.volume=volume_range.value;
        value.innerHTML=parseInt(volume_range.value*100);
        volume_range.style="background-size:"+volume_range.value*100+"%";
    }
    const song_name=document.querySelector("#songname_audio");
    function progress(){                                                                        //歌曲进度
        let audio=document.querySelector("#songname_audio>div.display").childNodes[0];
        let cutmin=timedata(parseInt(audio.currentTime/60));
        let cutsec=timedata(parseInt(audio.currentTime%60));
        let durmin=timedata(parseInt(audio.duration/60));
        let dursec=timedata(parseInt(audio.duration%60));
        document.getElementById("song_range").value=audio.currentTime;
        document.getElementById("song_range").max=audio.duration;
        document.getElementById("song_range").style="background-size: "+(audio.currentTime/audio.duration)*100+"%;"
        document.getElementById("song_progress").childNodes[0].innerHTML=cutmin+":"+cutsec+"/"+durmin+":"+dursec;
        if(audio.currentTime>=audio.duration){
            next_song();
        }
    }          
    function timedata(num){                                                                      //设置时间格式 
        if(num<10){
            num="0"+num;
        }
        return num;
    }
    function time_adjust(){                                                             //滑动进度条设置歌曲进度
        let audio=document.querySelector("#songname_audio>div.display").childNodes[0];
        audio.currentTime=document.getElementById("song_range").value;
        progress();
    }    
    function Lyrics_load(){ 
        let lyrics_txt;                                                                 //载入歌词
        try{
            lyrics_txt=document.getElementById(""+song_info.songlrc_id[songnum]+"").innerHTML;
            lyrics_txt=lyrics_txt.split(/[[]/);
        }catch(e){
            lyrics_txt=["没有找到歌词"];
        }
        let lyrics_time=lyrics_txt.map((value)=>{
            return value.slice(value.indexOf("[")+1,value.indexOf("]"))
        });
        let lyrics_text=lyrics_txt.map((value)=>{
            return value.slice(value.indexOf("]")+1)
        });
        let lyrics_div=document.createElement("div");
        for(let i=0;i<lyrics_time.length;i++){
            let Lyrics_span=document.createElement("span");
            Lyrics_span.title=lyrics_time[i];
            Lyrics_span.appendChild(document.createTextNode(lyrics_text[i]));
            lyrics_div.appendChild(Lyrics_span);
            document.getElementById("lyrics_main_div").appendChild(lyrics_div);
        }
    }
    function Lyrics_roll(){                                                                 //歌词滚动
        let lyrics_div=document.getElementById("lyrics_main_div").childNodes[0];
        let audio=document.querySelector("#songname_audio>div.display").childNodes[0];
        let cuttime=timedata(parseInt(audio.currentTime/60))+":"+timedata(parseInt(audio.currentTime%60));
        let arr=new Array();   
        for(let i=0;i<=lyrics_div.childNodes.length-1;i++){
            arr.push(lyrics_div.childNodes[i].title);              
        }  
        for(let i=0;i<=arr.length;i++){
            if(i<arr.length){ 
                if(cuttime>=arr[i]&&cuttime<=arr[i+1]){  
                    lyrics_div.childNodes[i].className="singing_lyrics";
                    for(let j=0;j<i;j++){
                        lyrics_div.childNodes[j].className="no_display"
                    }
                    for(let k=arr.length-1;k>i;k--){
                        lyrics_div.childNodes[k].className=""
                    }
                }
            }
            else if(i>=arr.length&&cuttime>=arr[arr.length-1]){
                lyrics_div.childNodes[arr.length-1].className="singing_lyrics"
                for(let j=0;j<arr.length-1;j++){
                    lyrics_div.childNodes[j].className="no_display"
                }
            }
        }
    }                      
    document.getElementById("last_button").addEventListener("click",last_song);
    document.getElementById("next_button").addEventListener("click",next_song);
    document.getElementById("play_button_div").addEventListener("click",playbutton);
    document.getElementById("voice_button").addEventListener("click",visibility_voice_bar);
    // document.getElementById("voice_range").addEventListener("mousemove",voice_adjust);
    // document.getElementById("song_range").addEventListener("mousemove",time_adjust);//增加了这个事件监听播放变卡//mousemove操作导致变卡
</script>
</html>
